#
# FILENAME:     kickstart-redhat-6.cfg
# AUTHOR:       Bennett Samowich <bsamowich@foolean.org>
# DATE:         2015-10-30
#
# DESCRIPTION:
#   Preseed configuration file for RedHat 6
#
#   This kickstart file will install a base RedHat system using a partitioning
#   layout based on the number and size of the disks.
#
#   PXE Init Arguments
#   ==================
#
#   raidtype    - The RAID type to build (e.g. none, 0, 1, 5, 6, 10)
#
#       If raidtype is set to 'none' (the default) then the
#       first disk will be formatted as a non-RAID, single disk.
#
#       NOTE: The /boot partition will always be RAID-1, unless single disk
#             is selected.  The number of disks and spares used in the /boot
#             partition will follow the 'raiddisks' and 'raidspares' options.
#
#   raiddisks   - The number of active disks to include in the volume
#
#   raidspares  - The number of spare disks to include in the volume
#
#   The installer itself will throw the error If the requested number of
#   disks, spares, and raid type can not be fullfilled.
#
#   Partition Sizing (smallest disk < 40G)
#   =======================================
#   Swap            384(MB)
#   /               800(MB)
#   /boot           256(MB)
#   /home           32(MB)      [ nodev ]
#   /var            512(MB)
#   /usr            1280(MB)
#   /usr/local      256(MB)
#   /tmp            256(MB)     [ nodev, nosuid, noexec ]
#   /var/tmp        256(MB)     [ nodev, nosuid, noexec ]
#   /var/log        1024(MB)
#   /var/log/audit  1024(MB)
#
#   Partition Sizing (smallest disk >= 40G)
#   =======================================
#   Swap            4096(MB)
#   /               896(MB)
#   /boot           256(MB)
#   /home           4096(MB)    [ nodev ]
#   /var            7168(MB)
#   /usr            4096(MB)
#   /usr/local      512(MB)
#   /tmp            4096(MB)    [ nodev, nosuid, noexec ]
#   /var/tmp        4096(MB)    [ nodev, nosuid, noexec ]
#   /var/log        8192(MB)
#   /var/log/audit  8192(MB)
#
#   Initial Passwords
#   =================
#
#   The initial root and boot menu password is 'changeme'.
#
#   You will be prompted to change the root password at first login.
#
#   CIS Benchmark Compliance
#   ========================
#
#   This kickstart attempts to create a CIS compliant system.  The settings
#   are based on the RedHat 6 Benchmark v1.1.0 document dated 2015-04-02.
#
#   [ CIS Benchmark Download ]
#   https://benchmarks.cisecurity.org/downloads/show-single/?file=redhat6.110
#
#   A CIS-CAT audit reports the following failures.
#
#       1.1.6 Bind Mount the /var/tmp directory to /tmp
#
#       Accepted as compliant:
#       We create a separate /var/tmp partition instead of bind mounting.
#
#       1.3.2 Implement Periodic Execution of File Integrity
#
#       Accepted as compliant:
#       We configure AIDE in /etc/cron.d/aide where the CIS audit tool only
#       looks in /var/spool/cron/root.
#
#       1.4.2 Set the SELinux State
#
#       Accepted as non-compliant:
#       Kickstart sets selinux to permissive where the CIS audit tool
#       looks for enforcing.
#
#       5.1.5 Configure rsyslog to Send Logs to a Remote Log Host
#
#       Accepted as non-compliant:
#       The kickstart does not set the remote host because that would be
#       handled by configuration management as the exact remote loghost
#       will vary.
#
#       6.2 Configure SSH (14 total tests)
#
#       Accepted as compliant:
#       The kickstart does not install ssh where the CIS audit tool looks for
#       the presence of various settings in /etc/ssh/sshd_config by grepping
#       for them and failing any empty returns.  All tests fail because the
#       configuration file does not exist.
#
#       9.2.11 Check Groups in /etc/passwd
#
#       Accepted as compliant:
#       The audit script in the PDF benchmark passes where the CIS audit tool
#       fails.
#
#       9.2.12 Check That Users Are Assigned Valid Home Directories
#
#       Accepted as compliant:
#       The audit script in the PDF benchmark passes where the CIS audit tool
#       fails  The only user that is missing a home directory is ftp however,
#       the uid is less than 1000 so it is excluded from the audit script in
#       the PDF.
#
##############################################################################

# Set the language to US english
lang en_US.UTF-8

# Sets system keyboard type
keyboard us

# Set the time zone to EST
timezone --utc America/New_York

# Set the default root password.  This can also be encrypted.
# To pre-encrypt the password use the openssl command:
#     openssl passwd -1 <PASSWORD>
rootpw changeme

# Install in text mode
text

# Set the boot loader options.  
# CIS: 1.5.3 Set Boot Loader Password
# NOTE: The grub password chould be changed after build.  To do so,
#       modify /etc/grub.conf.  A new password hash can be created
#       created by running grub-crypt --sha-512.
bootloader --location=mbr --append hdb=ide-scsi --password=changeme

# Install Linux, don't upgrade
install

# Skip the X Windows configuration
skipx

# Configure network settings
# Examples:
#   DHCP:   network --device=eth0 --bootproto=dhcp --noipv6
#   STATIC: network --device eth0 --bootproto static --ip <IP> \
#                   --netmask <NETMASK> --gateway <GATEWAY>    \
#                   --nameserver <DNS1>,<DNS2>,<DNS3> --noipv6 \
#                   --hostname <HOSTNAME>
network --bootproto=dhcp

# Install from our URL
url --url http://replace-with-your-url-here

# Configure how passwords are stored
authconfig --enableshadow --passalgo=sha512

# Clear all of the existing partitions from the disk adn make new ones
# (Note: This layout requires a minimum of a 5GB drive)
# The layout is comprised of recommendations from various security
# related resources.
zerombr
clearpart --all --initlabel

# The partitioning layout will be assembled in the %pre section
%include /tmp/partitions.ks

# SELinux
# Options are 'enforcing', 'permissive'
# CIS: 1.4.1 Enable SELinux in /etc/grub.conf (OK: default is compliant)
# CIS: 1.4.2 Set the SELinux State (OK: set to permissive)
# CIS: 1.4.3 Set the SELinux Policy (OK: default is compliant)
# CIS: 1.4.6 Check for Unconfined Daemons (OK: default is compliant)
selinux --permissive

# Services that should be enabled or disabled
# CIS: 5.1.2 Activate the rsyslog Service
# CIS: 3.3 Disable Avahi Server
# CIS: 3.4 Disable Print Server - CUPS
# CIS: 3.8 Disable NFS and RPC
# CIS: 4.7 Enable iptables
# CIS: 4.8 Enable ip6tables
# CIS: 5.2.2 Enable auditd Service
# CIS: 6.1.2 Enable crond Daemon
services --enabled auditd,crond,iptables,ip6tables,rsyslog --disabled avahi-daemon,cups,nfslock,rpcgssd,rpcbind,rpcidmapd,rpcsvcgssd

# Reboot the machine when done.
# (It's up to you to remove the boot media)
reboot

# Packages that we will start with.
# CIS: 4.5.1 Install TCP Wrappers
# CIS: 5.1.1 Install the rsyslog package
# CIS: 1.3.1 Install AIDE
# CIS: 6.1.1 Enable anacron Daemon
%packages --nobase
@core --nodefaults
aide
audit
cronie-anacron
mercurial
ntp
redhat-lsb
rsyslog
tcp_wrappers
# Packages not to install
# CIS: 1.4.4 Remove SETroubleshoot
# CIS: 1.4.5 Remove MCS Translation Service (mcstrans)
# CIS: 2.1.1 Remove telnet-server
# CIS: 2.1.2 Remove telnet Clients
# CIS: 2.1.3 Remove rsh-server
# CIS: 2.1.4 Remove rsh
# CIS: 2.1.5 Remove NIS Client
# CIS: 2.1.6 Remove NIS Server
# CIS: 2.1.7 Remove tftp
# CIS: 2.1.8 Remove tftp-server
# CIS: 2.1.9 Remove talk
# CIS: 2.1.10 Remove talk-server
# CIS: 2.1.11 Remove xinetd
# CIS: 3.2 Remove the X Window System
# CIS: 3.5 Remove DHCP Server
# CIS: 3.7 Remove LDAP
# CIS: 3.9 Remove DNS Server
# CIS: 3.10 Remove FTP Server
# CIS: 3.11 Remove HTTP Server
# CIS: 3.12 Remove Dovecot (IMAP and POP3 services)
# CIS: 3.13 Remove Samba
# CIS: 3.14 Remove HTTP Proxy Server
# CIS: 3.15 Remove SNMP Server
-aic94xx-firmware*
-alsa-*
-bind
-biosdevname
-btrfs-progs*
-cups
-cups-libs
-dhcp
-dovecot
-dracut-network
-httpd
-iprutils
-ivtv*
-iwl*firmware
-libertas*
-kexec-tools
-mcstrans
-net-snmp
-NetworkManager*
-openldap*
-openssh*
-plymouth*
-postfix
-rsh
-rsh-server
-samba
-setroubleshoot
-squid
-talk
-talk-server
-telnet
-telnet-server
-tftp
-tftp-server
-vsfstpd
-xorg-x11-server-common
-xinetd
-ypbind
-ypserv
%end

# The following commands are executed at the beginning of the installation
# process by /bin/sh.
%pre
#!/bin/sh

# Get any kernel options and convert them to environment variables
set -- $(cat /proc/cmdline)
for I in $*; do case "$I" in *=*) eval $I;; esac; done

# Create a file that contains the kickstart URL as well as git,
# sha1, and sha256 hashes into the resulting image.  The purpose
# of which is to provide the ability to show when and how the
# system was built.
cat << EOF >> /tmp/tag-install.sh
#!/bin/sh

while [ ! -d /mnt/sysimage/etc ]
do
    sleep 5
done
(   echo "date:    $(date)"
    echo ""
    echo "ks:      ${ks}"
    echo "git-sha: $((printf "blob $(stat -c %s /tmp/ks.cfg)\0"; cat /tmp/ks.cfg) | sha1sum | awk '{print $1}')"
    echo "sha1:    $(sha1sum /tmp/ks.cfg | awk '{print $1}')"
    echo "sha256:  $(sha256sum /tmp/ks.cfg | awk '{print $1}')"
) > /mnt/sysimage/etc/build-info
chmod 0000 /mnt/sysimage/etc/build-info
EOF
chmod 700 /tmp/tag-install.sh
/bin/sh /tmp/tag-install.sh > /dev/null 2>&1 < /dev/null &

# The RedHat 7 installer based script 'list-harddrives' also shows any
# pre-existing linux-raid partitions as part of the disk list.  It is
# for that reason that we resort to parsing the output of lsblk.  The
# lsblk command doesn't exist in RedHat 6 and list-harddrives behaves
# correctly so we'll only actually use lsblk when it exists.
if [ -f "/usr/bin/lsblk" ]; then
    LIST_HARDDRIVES="lsblk -io KNAME,TYPE | grep disk"
else
    LIST_HARDDRIVES="list-harddrives"
fi

# Default partition sizes
SWAP_SZ=4096
LV01_SZ=896
LV02_SZ=4096
LV03_SZ=7168
LV04_SZ=4096
LV05_SZ=512
LV06_SZ=4096
LV07_SZ=4096
LV08_SZ=8192
LV09_SZ=8192

# Get the smallest disk size
SMALLEST_DISK=$(                      \
    ( eval ${LIST_HARDDRIVES}       | \
        awk '{print $1}'            | \
        while read DISK; do           \
            fdisk -l "/dev/${DISK}" | \
              grep "^Disk .* bytes" | \
              cut -f5 -d\ ;
        done                          \
    ) | sort -un | head -n1           \
);

# Use a smaller layout if the disk is smaller than 40G
if [ ${SMALLEST_DISK} -lt 40000000000 ]; then
    SWAP_SZ=384
    LV01_SZ=800
    LV02_SZ=32
    LV03_SZ=512
    LV04_SZ=1280
    LV05_SZ=256
    LV06_SZ=256
    LV07_SZ=256
    LV08_SZ=1024
    LV09_SZ=1024
fi

# A few more variables
DISKS=$(eval ${LIST_HARDDRIVES} | wc -l);
RAID_TYPE="none"
RAID_DISKS="${DISKS}"
RAID_SPARES="0";

if [ "${raidtype}" == "none" ]; then
    raiddisks=1;
fi
if [ "${raidtype}" != "" ]; then
    RAID_TYPE="${raidtype}"
fi
if [ "${raiddisks}" != "" ]; then
    RAID_DISKS="${raiddisks}"
fi
if [ "${raidspares}" != "" ]; then
    RAID_SPARES="${raidspares}"
fi
RAID_TOTAL=$(( ${RAID_DISKS} + ${RAID_SPARES} ))

# Build our partitioning layout
if [ "${RAID_TOTAL}" == "1" ]; then
    cat << EOF >> /tmp/partitions.ks
part /boot --fstype=ext4 --size=256 --ondisk sda
part pv.01 --grow        --size=1   --ondisk sda
EOF
else
    INDEX=1
    RAID_LIST0=""
    RAID_LIST1=""
    for DISK in $(eval ${LIST_HARDDRIVES} | awk '{print $1}' | head -n ${RAID_TOTAL}); do
        RAID_LIST0="${RAID_LIST0} raid.0${INDEX}"
        RAID_LIST1="${RAID_LIST1} raid.1${INDEX}"
        cat << EOF >> /tmp/partitions.ks
part raid.0${INDEX} --size=256        --ondisk ${DISK}
part raid.1${INDEX} --size=1   --grow --ondisk ${DISK}
EOF
        INDEX=$(( ${INDEX} + 1 ))
    done
    cat << EOF >> /tmp/partitions.ks
raid /boot --fstype=ext4 --level=RAID1 --spares=${RAID_SPARES} --device=md0 ${RAID_LIST0}
raid pv.01               --level=RAID${RAID_TYPE} --spares=${RAID_SPARES} --device=md1 ${RAID_LIST1}
EOF
fi

cat << EOF >> /tmp/partitions.ks

# CIS: 1.1.1 Create Separate Partition for /tmp 
# CIS: 1.1.2 Set nodev option for /tmp Partition
# CIS: 1.1.3 Set nosuid option for /tmp Partition
# CIS: 1.1.4 Set noexec option for /tmp Partition
# CIS: 1.1.5 Create Separate Partition for /var
# CIS: 1.1.6 Bind Mount the /var/tmp directory to /tmp (we create a separate /var/tmp directory instead)
# CIS: 1.1.7 Create Separate Partition for /var/log
# CIS: 1.1.8 Create Separate Partition for /var/log/audit
# CIS: 1.1.9 Create Separate Partition for /home
# CIS: 1.1.10 Add nodev Option to /home
# CIS: 1.1.11 Add nodev Option to Removable Media Partitions (no removable media in fstab post-install)
# CIS: 1.1.12 Add noexec Option to Removable Media Partitions (no removable media in fstab post-install)
# CIS: 1.1.13 Add nosuid Option to Removable Media Partitions (no removable media in fstab post-install)
# CIS: 1.1.17 Set Sticky Bit on All World-Writable Directories (OK: default is compliant)
volgroup vg0 pv.01
logvol swap           --fstype=ext4 --vgname=vg0 --size=${SWAP_SZ} --name=swap
logvol /              --fstype=ext4 --vgname=vg0 --size=${LV01_SZ} --name=lv01
logvol /home          --fstype=ext4 --vgname=vg0 --size=${LV02_SZ} --name=lv02 --fsoptions="nodev"
logvol /var           --fstype=ext4 --vgname=vg0 --size=${LV03_SZ} --name=lv03
logvol /usr           --fstype=ext4 --vgname=vg0 --size=${LV04_SZ} --name=lv04
logvol /usr/local     --fstype=ext4 --vgname=vg0 --size=${LV05_SZ} --name=lv05
logvol /tmp           --fstype=ext4 --vgname=vg0 --size=${LV06_SZ} --name=lv06 --fsoptions="nodev,nosuid,noexec"
logvol /var/tmp       --fstype=ext4 --vgname=vg0 --size=${LV07_SZ} --name=lv07 --fsoptions="nodev,nosuid,noexec"
logvol /var/log       --fstype=ext4 --vgname=vg0 --size=${LV08_SZ} --name=lv08
logvol /var/log/audit --fstype=ext4 --vgname=vg0 --size=${LV09_SZ} --name=lv09
EOF
%end

# The following commands are executed at the end of the installation
# process by /bin/sh while you are chrooted into the new system.  This
# allows you to add user accounts, turn on or off autobooted software,
# etc..
%post

# Standardize our logging format
LOGGER="logger -i -p local1.info -t 'kickstart'"

# Proxy to use for YUM
YUMPROXYSVR=""
YUMPROXYUSER=""
YUMPROXYPASS=""

# Turn off packages that we don't want running
# CIS: 2.1.12 Disable chargen-dgram
# CIS: 2.1.13 Disable chargen-stream
# CIS: 2.1.14 Disable daytime-dgram
# CIS: 2.1.15 Disable daytime-stream
# CIS: 2.1.16 Disable echo-dgram
# CIS: 2.1.17 Disable echo-stream
# CIS: 2.1.18 Disable tcpmux-server
SERVICES="
    acpidatd
    autofs
    chargen-dgram
    chargen-stream
    cpuspeed
    cups
    daytime-dgram
    daytime-stream
    echo-dgram
    echo-stream
    gpm
    haldaemon
    isdn
    messagebus
    netfs
    nfslock
    openibd
    pcmcia
    portmap
    rawdevices
    rpcgssd
    rpcidmapd
    tcpmux-server
    xinetd
"
for SERVICE in ${SERVICES}
do
   echo "disabling ${SERVICE}" | ${LOGGER}
   chkconfig ${SERVICE} off
done

# Create a repo entry from the kickstart URL
KS_URL=$(grep "^url" /root/anaconda-ks.cfg | cut -f2- -d= )
( cat -<<EOF
[kickstart-url]
name=Red Hat Enterprise Linux 6 Kickstart URL
baseurl=${KS_URL}
enabled=1
EOF
) > /etc/yum.repos.d/rhel-kickstart-url.repo


# Import GPG keys
# CIS: 1.2.1 Verify RedHat GPG Key is Installed 
# CIS: 1.2.2 Verify that gpgcheck is Globally Activated (active by default)
rpm --import `find /usr/share/doc -name '*GPG*' -type f | grep -v -i redhat | \
        head -1` 2> /dev/null
rpm --import `find /usr/share/doc -name '*GPG*' -type f | grep -i redhat | \
        head -1` 2> /dev/null
rpm --import `find /etc/pki/rpm-gpg -name '*GPG*' -type f` 2>/dev/null

# Set up the EPEL repository (needed for Mercurial and Puppet, among others)
rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-6.noarch.rpm

# Protect base and core packages from EPEL and other repositories.
yum install -y yum-plugin-protectbase.noarch

# With EPEL installed, install puppet, ssmtp
# CIS: 3.16 Configure Mail Transfer Agent for Local-Only Mode
yum install -y puppet ssmtp

# Remove sendmail after ssmtp is installed
yum remove -y sendmail

# Install etckeeper
yum install -y etckeeper
if [ -f /etc/etckeeper/etckeeper.conf ]
then
    cp /etc/etckeeper/etckeeper.conf /etc/etckeeper/etckeeper.conf.orig
    ( cat /etc/etckeeper/etckeeper.conf | \
      sed -e 's/#VCS=\"hg\"/VCS=\"hg\"/'  \
          -e 's/VCS=\"git\"/#VCS=\"git\"/'
    ) > /etc/etckeeper/etckeeper.conf.new
    mv /etc/etckeeper/etckeeper.conf.new /etc/etckeeper/etckeeper.conf
    etckeeper init
    etckeeper commit "Initial commit of base system"
fi

# Remove duplicate kernels
for i in kernel kernel-smp
do
   NONCE=`rpm -q $i 2> /dev/null | wc -l | awk '{print $1}'`
   export CNT=`echo " 0${NONCE} + 0" | bc`

   echo "cnt: $CNT pre while $NONCE " | ${LOGGER}
   sleep 5

   while [ $CNT -gt 1 ]
   do
      NONCE=`rpm -q $i --last | awk '{print $1}' | tail -1`

      echo "kernel: $NONCE " | ${LOGGER}
      sleep 5

      rpm -e $NONCE  && echo "  removed extra $NONCE kernel" | ${LOGGER}

      NONCE=`rpm -q $i 2> /dev/null | wc -l | awk '{print $1}'`
      export CNT=`echo " 0${NONCE} + 0" | bc`

      echo "cnt: $CNT in while $NONCE " | ${LOGGER}
      sleep 5
   done
done

# Attempt package updates
# CIS: 1.2.3 Obtain Software Package Updates with yum
echo "Looking for updates via 'yum'" | ${LOGGER}
yum -d 0 -e 0 -t -y update

# Free up the yum cached files
echo "Cleaning up yum cached files" | ${LOGGER}
yum -y clean all

# Force root password change
echo "Forcing root password change" | ${LOGGER}
chage -d 0 root
etckeeper commit "Force root to change password"

# Set the initial Puppet configuration
cp /etc/puppet/puppet.conf /etc/puppet/puppet.conf.orig
cat << EOF > /etc/puppet/puppet.conf
[main]
logdir=/var/log/puppet
vardir=/var/lib/puppet
manifestdir=/var/lib/puppet/manifests
ssldir=/var/lib/puppet/ssl
rundir=/var/run/puppet
factpath=\$vardir/lib/facter
pluginsync=true
runinterval=315569260
server=puppet
summarize=true
show_diff = true
listen=false
EOF
etckeeper commit "Set basic puppet.conf"


#
# CIS Benchmark Configurations
#

# CIS: 1.1.18 Disable Mounting of cramfs Filesystems 
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 1.1.18 Disable Mounting of cramfs Filesystems 
install cramfs /bin/true
EOF
etckeeper commit "CIS: 1.1.18 Disable Mounting of cramfs Filesystems"

# CIS: 1.1.19 Disable Mounting of freevxfs Filesystems
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 1.1.19 Disable Mounting of freevxfs Filesystems
install freevxfs /bin/true
EOF
etckeeper commit "CIS: 1.1.19 Disable Mounting of freevxfs Filesystems"

# CIS: 1.1.20 Disable Mounting of jffs2 Filesystems
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 1.1.20 Disable Mounting of jffs2 Filesystems
install jffs2 /bin/true
EOF
etckeeper commit "CIS: 1.1.20 Disable Mounting of jffs2 Filesystems"

# CIS: 1.1.21 Disable Mounting of hfs Filesystems
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 1.1.21 Disable Mounting of hfs Filesystems
install hfs /bin/true
EOF
etckeeper commit "CIS: 1.1.21 Disable Mounting of hfs Filesystems"

# CIS: 1.1.22 Disable Mounting of hfsplus Filesystems
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 1.1.22 Disable Mounting of hfsplus Filesystems
install hfsplus /bin/true
EOF
etckeeper commit "CIS: 1.1.22 Disable Mounting of hfsplus Filesystems"

# CIS: 1.1.23 Disable Mounting of squashfs Filesystems
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 1.1.23 Disable Mounting of squashfs Filesystems
install squashfs /bin/true
EOF
etckeeper commit "CIS: 1.1.23 Disable Mounting of squashfs Filesystems"

# CIS: 1.1.24 Disable Mounting of udf Filesystems
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 1.1.24 Disable Mounting of udf Filesystems
install udf /bin/true
EOF
etckeeper commit "CIS: 1.1.24 Disable Mounting of udf Filesystems"

# CIS: 4.6.1 Disable DCCP
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 4.6.1 Disable DCCP
install dccp /bin/true
EOF
etckeeper commit " CIS: 4.6.1 Disable DCCP"

# CIS: 4.6.2 Disable SCTP
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 4.6.2 Disable SCTP
install sctp /bin/true
EOF
etckeeper commit " CIS: 4.6.2 Disable SCTP"

# CIS: 4.6.3 Disable RDS
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 4.6.3 Disable RDS
install rds /bin/true
EOF
etckeeper commit " CIS: 4.6.3 Disable RDS"

# CIS: 4.6.4 Disable TIPC"
cat << EOF >> /etc/modprobe.d/CIS.conf

# CIS: 4.6.4 Disable TIPC"
install tipc /bin/true
EOF
etckeeper commit "CIS: 4.6.4 Disable TIPC"

# CIS: 1.5.1 Set User/Group Owner on /etc/grub.conf
chown root.root /etc/grub.conf
etckeeper commit "CIS: 1.5.1 Set User/Group Owner on /etc/grub.conf"

# CIS: 1.5.2 Set Permissions on /etc/grub.conf
chmod 600 /etc/grub.conf
etckeeper commit "CIS: 1.5.2 Set Permissions on /etc/grub.conf"

# CIS: 1.5.4 Require Authentication for Single-User Mode
sed -i 's/^SINGLE=.*/SINGLE=\/sbin\/sulogin/' /etc/sysconfig/init
etckeeper commit "CIS: 1.5.4 Require Authentication for Single-User Mode"

# CIS: 1.5.5 Disable Interactive Boot
sed -i 's/^PROMPT=.*/PROMPT=no/' /etc/sysconfig/init
etckeeper commit "CIS: 1.5.5 Disable Interactive Boot"

# CIS: 1.6.1 Restrict Core Dumps
cat << EOF >> /etc/security/limits.conf

# CIS: 1.6.1 Restrict Core Dumps
* hard core 0
EOF
cat << EOF >> /etc/sysctl.conf

# CIS: 1.6.1 Restrict Core Dumps
fs.suid_dumpable=0
EOF
etckeeper commit "CIS: 1.6.1 Restrict Core Dumps"

# CIS: 3.1 Set Daemon umask
cat << EOF >> /etc/sysconfig/init

# CIS: 3.1 Set Daemon umask
umask 027
EOF
etckeeper commit "CIS: 3.1 Set Daemon umask"

# CIS: 1.6.2 Configure ExecShield
cat << EOF >> /etc/sysctl.conf

# CIS: 1.6.2 Configure ExecShield
kernel.exec-shield = 1
EOF
etckeeper commit "CIS: 1.6.2 Configure ExecShield"

# CIS: 1.6.3 Enable Randomized Virtual Memory Region Placement
cat << EOF >> /etc/sysctl.conf

# CIS: 1.6.3 Enable Randomized Virtual Memory Region Placement
kernel.randomize_va_space = 2
EOF
etckeeper commit "CIS: 1.6.3 Enable Randomized Virtual Memory Region Placement"

# CIS: 3.6 Configure Network Time Protocol (NTP)
sed -i 's/^\(restrict default\)/\1 kod/' /etc/ntp.conf
sed -i 's/^\(restrict default kod.*\)/\1\nrestrict -6 default kod nomodify notrap nopeer noquery/' /etc/ntp.conf
sed -i 's/^OPTIONS=.*/OPTIONS="-g -u ntp:ntp"/' /etc/sysconfig/ntpd
etckeeper commit "CIS: 3.6 Configure Network Time Protocol (NTP)"

# CIS: 4.1.1 Disable IP Forwarding
cat << EOF >> /etc/sysctl.conf

# CIS: 4.1.1 Disable IP Forwarding
net.ipv4.ip_forward=0
EOF
etckeeper commit "CIS: 4.1.1 Disable IP Forwarding"

# CIS: 4.1.2 Disable Send Packet Redirects
cat << EOF >> /etc/sysctl.conf

# CIS: 4.1.2 Disable Send Packet Redirects
net.ipv4.conf.all.send_redirects=0
net.ipv4.conf.default.send_redirects=0
EOF
etckeeper commit "CIS: 4.1.2 Disable Send Packet Redirects"

# CIS: 4.2.1 Disable Source Routed Packet Acceptance
cat << EOF >> /etc/sysctl.conf

# CIS: 4.2.1 Disable Source Routed Packet Acceptance
net.ipv4.conf.all.accept_source_route=0
net.ipv4.conf.default.accept_source_route=0
EOF
etckeeper commit "CIS: 4.2.1 Disable Source Routed Packet Acceptance"

# CIS: 4.2.2 Disable ICMP Redirect Acceptance
cat << EOF >> /etc/sysctl.conf

# CIS: 4.2.2 Disable ICMP Redirect Acceptance
net.ipv4.conf.all.accept_redirects=0
net.ipv4.conf.default.accept_redirects=0
EOF
etckeeper commit "CIS: 4.2.2 Disable ICMP Redirect Acceptance"

# CIS: 4.2.3 Disable Secure ICMP Redirect Acceptance
cat << EOF >> /etc/sysctl.conf

# CIS: 4.2.3 Disable Secure ICMP Redirect Acceptance
net.ipv4.conf.all.secure_redirects=0
net.ipv4.conf.default.secure_redirects=0
EOF
etckeeper commit "CIS: 4.2.3 Disable Secure ICMP Redirect Acceptance"

# CIS: 4.2.4 Log Suspicious Packets
cat << EOF >> /etc/sysctl.conf

# CIS: 4.2.4 Log Suspicious Packets
net.ipv4.conf.all.log_martians=1
net.ipv4.conf.default.log_martians=1
EOF
etckeeper commit "CIS: 4.2.4 Log Suspicious Packets"

# CIS: 4.2.5 Enable Ignore Broadcast Requests
cat << EOF >> /etc/sysctl.conf

# CIS: 4.2.5 Enable Ignore Broadcast Requests
net.ipv4.icmp_echo_ignore_broadcasts=1
EOF
etckeeper commit "CIS: 4.2.5 Enable Ignore Broadcast Requests"

# CIS: 4.2.6 Enable Bad Error Message Protection
cat << EOF >> /etc/sysctl.conf

# CIS: 4.2.6 Enable Bad Error Message Protection
net.ipv4.icmp_ignore_bogus_error_responses=1
EOF
etckeeper commit "CIS: 4.2.6 Enable Bad Error Message Protection"

# CIS: 4.2.7 Enable RFC-recommended Source Route Validation
cat << EOF >> /etc/sysctl.conf

# CIS: 4.2.7 Enable RFC-recommended Source Route Validation
net.ipv4.conf.all.rp_filter=1
net.ipv4.conf.default.rp_filter=1
EOF
etckeeper commit "CIS: 4.2.7 Enable RFC-recommended Source Route Validation"

# CIS: 4.2.8 Enable TCP SYN Cookies
cat << EOF >> /etc/sysctl.conf

# CIS: 4.2.8 Enable TCP SYN Cookies
net.ipv4.tcp_syncookies=1
EOF
etckeeper commit "CIS: 4.2.8 Enable TCP SYN Cookies"

# CIS: 4.4.1.1 Disable IPv6 Router Advertisements
cat << EOF >> /etc/sysctl.conf

# CIS: 4.4.1.1 Disable IPv6 Router Advertisements
net.ipv6.conf.all.accept_ra=0
net.ipv6.conf.default.accept_ra=0
EOF
etckeeper commit "CIS: 4.4.1.1 Disable IPv6 Router Advertisements"

# CIS: 4.4.1.2 Disable IPv6 Redirect Acceptance
cat << EOF >> /etc/sysctl.conf

# CIS: 4.4.1.2 Disable IPv6 Redirect Acceptance
net.ipv6.conf.all.accept_redirects=0
net.ipv6.conf.default.accept_redirects=0
EOF
etckeeper commit "CIS: 4.4.1.2 Disable IPv6 Redirect Acceptance"

# CIS: 4.4.2 Disable IPv6
cat << EOF >> /etc/sysctl.conf

# CIS: 4.4.2 Disable IPv6
net.ipv6.conf.all.disable_ipv6=1
EOF
etckeeper commit "CIS: 4.4.2 Disable IPv6"

# CIS: 4.5.2 Create /etc/hosts.allow (installed by default)
# CIS: 4.5.3 Verify Permissions on /etc/hosts.allow
chmod 644 /etc/hosts.allow
etckeeper commit "CIS: 4.5.3 Verify Permissions on /etc/hosts.allow"

# CIS: 4.5.4 Create /etc/hosts.deny (installed by default)
echo "ALL: ALL" >> /etc/hosts.deny
etckeeper commit "CIS: 4.5.4 Create /etc/hosts.deny"

# CIS: 4.5.5 Verify Permissions on /etc/hosts.deny
chmod 644 /etc/hosts.deny
etckeeper commit "CIS: 4.5.5 Verify Permissions on /etc/hosts.deny"

# CIS: 5.3 Configure logrotate
sed -i 's/^{/\/var\/log\/boot.log\n{/' /etc/logrotate.d/syslog
etckeeper commit "CIS: 5.3 Configure logrotate"

# CIS: 5.1.3 Configure /etc/rsyslog.conf (default install)
# CIS: 5.1.4 Create and Set Permissions on rsyslog Log Files
touch /var/log/messages /var/log/secure /var/log/maillog /var/log/cron /var/log/spooler /var/log/boot.log
chown root:root /var/log/messages /var/log/secure /var/log/maillog /var/log/cron /var/log/spooler /var/log/boot.log
chmod 0600 /var/log/messages /var/log/secure /var/log/maillog /var/log/cron /var/log/spooler /var/log/boot.log
cat << EOF >> /etc/rsyslog.d/00_FileCreateMode
# CIS: 5.1.4 Create and Set Permissions on rsyslog Log Files
\$FileCreateMode 0600
\$umask 0077
EOF
cat << EOF >> /etc/rc.local

# CIS: 5.1.4 Create and Set Permissions on rsyslog Log Files
# NOTE: This is a kludge since boot.log is actuall created
#       with mode 0644 before rsyslog even starts.
chmod 0600 /var/log/boot.log
EOF
etckeeper commit "CIS: 5.1.4 Create and Set Permissions on rsyslog Log Files"

# CIS: 1.3.2 Implement Periodic Execution of File Integrity
cat << EOF >> /etc/cron.d/aide
# CIS: 1.3.2 Implement Periodic Execution of File Integrity
0 5 * * * root /usr/sbin/aide --check
EOF
etckeeper commit "CIS: 1.3.2 Implement Periodic Execution of File Integrity"

# CIS: 5.2.1.2 Disable System on Audit Log Full 
sed -i 's/^space_left_action .*/space_left_action = email/' /etc/audit/auditd.conf
sed -i 's/^action_mail_acct .*/action_mail_acct = root/' /etc/audit/auditd.conf
sed -i 's/^admin_space_left_action .*/admin_space_left_action = halt/' /etc/audit/auditd.conf
etckeeper commit "CIS: 5.2.1.2 Disable System on Audit Log Full"

# CIS: 5.2.1.3 Keep All Auditing Information
sed -i 's/^max_log_file_action .*/max_log_file_action = keep_logs/' /etc/audit/auditd.conf
etckeeper commit "CIS: 5.2.1.3 Keep All Auditing Information"

# CIS: 5.2.3 Enable Auditing for Processes That Start Prior to auditd
sed -i 's/^\(.*kernel.*\)/\1 audit=1/' /etc/grub.conf
etckeeper commit "CIS: 5.2.3 Enable Auditing for Processes That Start Prior to auditd"

# CIS: 5.2.4 Record Events That Modify Date and Time Information 
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.4 Record Events That Modify Date and Time Information 
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
-a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
-a always,exit -F arch=b64 -S clock_settime -k time-change
-a always,exit -F arch=b32 -S clock_settime -k time-change
-w /etc/localtime -p wa -k time-change
EOF
etckeeper commit "CIS: 5.2.4 Record Events That Modify Date and Time Information"

# CIS: 5.2.5 Record Events That Modify User/Group Information
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.5 Record Events That Modify User/Group Information
-w /etc/group -p wa -k identity
-w /etc/passwd -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity
EOF
etckeeper commit "CIS: 5.2.5 Record Events That Modify User/Group Information"

# CIS: 5.2.6 Record Events That Modify the System's Network Environment
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.6 Record Events That Modify the System's Network Environment
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale
-w /etc/issue -p wa -k system-locale
-w /etc/issue.net -p wa -k system-locale
-w /etc/hosts -p wa -k system-locale
-w /etc/sysconfig/network -p wa -k system-locale
EOF
etckeeper commit "CIS: 5.2.6 Record Events That Modify the System's Network Environment"

# CIS: 5.2.7 Record Events That Modify the System's Mandatory Access Controls
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.7 Record Events That Modify the System's Mandatory Access Controls
-w /etc/selinux/ -p wa -k MAC-policy
EOF
etckeeper commit "CIS: 5.2.7 Record Events That Modify the System's Mandatory Access Controls"

# CIS: 5.2.8 Collect Login and Logout Events
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.8 Collect Login and Logout Events
-w /var/log/faillog -p wa -k logins
-w /var/log/lastlog -p wa -k logins
-w /var/log/tallylog -p wa -k logins
EOF
etckeeper commit "CIS: 5.2.8 Collect Login and Logout Events"

# CIS: 5.2.9 Collect Session Initiation Information
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.9 Collect Session Initiation Information
-w /var/run/utmp -p wa -k session
-w /var/log/wtmp -p wa -k session
-w /var/log/btmp -p wa -k session
EOF
etckeeper commit "CIS: 5.2.9 Collect Session Initiation Information"

# CIS: 5.2.10 Collect Discretionary Access Control Permission Modification Events
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.10 Collect Discretionary Access Control Permission Modification Events
-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -F auid>=500 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -F auid>=500 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -F auid>=500 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -F auid>=500 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b64 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=500 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=500 -F auid!=4294967295 -k perm_mod
EOF
etckeeper commit "CIS: 5.2.10 Collect Discretionary Access Control Permission Modification Events"

# CIS: 5.2.11 Collect Unsuccessful Unauthorized Access Attempts to Files
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.11 Collect Unsuccessful Unauthorized Access Attempts to Files
-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=500 -F auid!=4294967295 -k access
-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=500 -F auid!=4294967295 -k access
-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=500 -F auid!=4294967295 -k access
-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=500 -F auid!=4294967295 -k access
EOF
etckeeper commit "CIS: 5.2.11 Collect Unsuccessful Unauthorized Access Attempts to Files"

# CIS: 5.2.12 Collect Use of Privileged Commands
( echo ""
  echo "# CIS: 5.2.12 Collect Use of Privileged Commands"
  find / \( -perm -4000 -o -perm -2000 \) -type f | \
    awk '{print "-a always,exit -F path=" $1 " -F perm=x -F auid>=500 -F auid!=4294967295 -k privileged" }'
) >> /etc/audit/audit.rules
etckeeper commit "CIS: 5.2.12 Collect Use of Privileged Commands"

# CIS: 5.2.13 Collect Successful File System Mounts
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.13 Collect Successful File System Mounts
-a always,exit -F arch=b64 -S mount -F auid>=500 -F auid!=4294967295 -k mounts
-a always,exit -F arch=b32 -S mount -F auid>=500 -F auid!=4294967295 -k mounts
EOF
etckeeper commit "CIS: 5.2.13 Collect Successful File System Mounts"

# CIS: 5.2.14 Collect File Deletion Events by User
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.14 Collect File Deletion Events by User
-a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=500 -F auid!=4294967295 -k delete
-a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=500 -F auid!=4294967295 -k delete
EOF
etckeeper commit "CIS: 5.2.14 Collect File Deletion Events by User"

# CIS: 5.2.15 Collect Changes to System Administration Scope (sudoers)
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.15 Collect Changes to System Administration Scope (sudoers)
-w /etc/sudoers -p wa -k scope
EOF
etckeeper commit "CIS: 5.2.15 Collect Changes to System Administration Scope (sudoers)"

# CIS: 5.2.16 Collect System Administrator Actions (sudolog) 
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.16 Collect System Administrator Actions (sudolog) 
-w /var/log/sudo.log -p wa -k actions
EOF
etckeeper commit "CIS: 5.2.16 Collect System Administrator Actions (sudolog)"

# CIS: 5.2.17 Collect Kernel Module Loading and Unloading
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.17 Collect Kernel Module Loading and Unloading
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-a always,exit -F arch=b64 -S init_module -S delete_module -k modules
EOF
etckeeper commit "CIS: 5.2.17 Collect Kernel Module Loading and Unloading"

# CIS: 5.2.18 Make the Audit Configuration Immutable
cat << EOF >> /etc/audit/audit.rules

# CIS: 5.2.18 Make the Audit Configuration Immutable
-e 2
EOF
etckeeper commit "CIS: 5.2.18 Make the Audit Configuration Immutable"

# CIS: 6.1.3 Set User/Group Owner and Permission on /etc/anacrontab
chown root:root /etc/anacrontab
chmod 0600 /etc/anacrontab
etckeeper commit "CIS: 6.1.3 Set User/Group Owner and Permission on /etc/anacrontab"

# CIS: 6.1.4 Set User/Group Owner and Permission on /etc/crontab 
chown root:root /etc/crontab
chmod 0600 /etc/crontab
etckeeper commit "CIS: 6.1.4 Set User/Group Owner and Permission on /etc/crontab"

# CIS: 6.1.5 Set User/Group Owner and Permission on /etc/cron.hourly
chown root:root /etc/cron.hourly
chmod 0600 /etc/cron.hourly
etckeeper commit "CIS: 6.1.5 Set User/Group Owner and Permission on /etc/cron.hourly"

# CIS: 6.1.6 Set User/Group Owner and Permission on /etc/cron.daily
chown root:root /etc/cron.daily
chmod 0600 /etc/cron.daily
etckeeper commit "CIS: 6.1.6 Set User/Group Owner and Permission on /etc/cron.daily"

# CIS: 6.1.7 Set User/Group Owner and Permission on /etc/cron.weekly
chown root:root /etc/cron.weekly
chmod 0600 /etc/cron.weekly
etckeeper commit "CIS: 6.1.7 Set User/Group Owner and Permission on /etc/cron.weekly"

# CIS: 6.1.8 Set User/Group Owner and Permission on /etc/cron.monthly
chown root:root /etc/cron.monthly
chmod 0600 /etc/cron.monthly
etckeeper commit "CIS: 6.1.8 Set User/Group Owner and Permission on /etc/cron.monthly"

# CIS: 6.1.9 Set User/Group Owner and Permission on /etc/cron.d
chown root:root /etc/cron.d
chmod 0700 /etc/cron.d
etckeeper commit "CIS: 6.1.9 Set User/Group Owner and Permission on /etc/cron.d"

# CIS: 6.1.10 Restrict at Daemon
rm /etc/at.deny
echo "root" > /etc/at.allow
chown root:root /etc/at.allow
chmod 0600 /etc/at.allow
etckeeper commit "CIS: 6.1.10 Restrict at Daemon"

# CIS: 6.1.11 Restrict at/cron to Authorized Users
rm /etc/cron.deny
echo "root" > /etc/cron.allow
chown root:root /etc/cron.allow
chmod 0600 /etc/cron.allow
etckeeper commit "CIS: 6.1.11 Restrict at/cron to Authorized Users"

# CIS: 6.3.1 Upgrade Password Hashing Algorithm to SHA-512
authconfig --passalgo=sha512 --update
etckeeper commit "CIS: 6.3.1 Upgrade Password Hashing Algorithm to SHA-512"

# CIS: 6.3.2 Set Password Creation Requirement Parameters Using pam_pwquality
sed -i 's/^password.*pam_cracklib.*/password    required      pam_cracklib.so try_first_pass retry=3 minlen=14 dcredit=-1 ucredit=-1 ocredit=-1 lcredit=-1/' /etc/pam.d/system-auth
etckeeper commit "CIS: 6.3.2 Set Password Creation Requirement Parameters Using pam_pwquality"

# CIS: 6.3.3 Set Lockout for Failed Password Attempts
sed -i 's/^\(auth.*env.so\)/\1\nauth        required      pam_faillock.so preauth audit silent deny=5 unlock_time=900/' /etc/pam.d/password-auth
sed -i 's/^auth.*pam_unix.so.*/auth        [success=1 default=bad] pam_unix.so/' /etc/pam.d/password-auth
sed -i 's/^\(auth.*pam_unix.so\)/\1\nauth        [default-die] pam_faillock.so authfail audit deny=5 unlock_time=900/' /etc/pam.d/password-auth
sed -i 's/^\(auth.*default-die.*\)/\1\nauth        sufficient pam_faillock.so authsucc audit deny=5 unlock_time=900/' /etc/pam.d/password-auth
sed -i 's/^\(auth.*env.so\)/\1\nauth        required      pam_faillock.so preauth audit silent deny=5 unlock_time=900/' /etc/pam.d/system-auth
sed -i 's/^auth.*pam_unix.so.*/auth        [success=1 default=bad] pam_unix.so/' /etc/pam.d/system-auth
sed -i 's/^\(auth.*pam_unix.so.*\)/\1\nauth        [default-die] pam_faillock.so authfail audit deny=5 unlock_time=900/' /etc/pam.d/system-auth
sed -i 's/^\(auth.*default-die.*\)/\1\nauth        sufficient pam_faillock.so authsucc audit deny=5 unlock_time=900/' /etc/pam.d/system-auth
etckeeper commit "CIS: 6.3.3 Set Lockout for Failed Password Attempts"

# CIS: 6.3.4 Limit Password Reuse
sed -i 's/^\(password.*pam_unix.*\)/\1 remember=5/' /etc/pam.d/system-auth
etckeeper commit "CIS: 6.3.4 Limit Password Reuse"

# CIS: 6.5 Restrict Access to the su Command
sed -i 's/^#\(auth.*required.*pam_wheel.*\)/\1/' /etc/pam.d/su
etckeeper commit "CIS: 6.5 Restrict Access to the su Command"

# CIS: 7.1.1 Set Password Expiration Days
sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS 90/' /etc/login.defs
for user in $(cut -f1 -d: /etc/passwd)
do
    chage --maxdays 90 $user
done
etckeeper commit "CIS: 7.1.1 Set Password Expiration Days"

# CIS: 7.1.2 Set Password Change Minimum Number of Days
sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS 7/' /etc/login.defs
for user in $(cut -f1 -d: /etc/passwd)
do
    chage --mindays 7 $user
done
etckeeper commit "CIS: 7.1.2 Set Password Change Minimum Number of Days"

# CIS: 7.1.3 Set Password Expiring Warning Days
sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE 7/' /etc/login.defs
for user in $(cut -f1 -d: /etc/passwd)
do
    chage --warndays 7 $user
done
etckeeper commit "CIS: 7.1.3 Set Password Expiring Warning Days"

# CIS: 7.4 Set Default umask for Users
cat << EOF >> /etc/profile

# CIS: 7.4 Set Default umask for Users
umask 077
EOF
cat << EOF >> /etc/bashrc

# CIS: 7.4 Set Default umask for Users
umask 077
EOF
for file in $(ls /etc/profile.d/)
do
    cat << EOF >> "/etc/profile.d/${file}"

# CIS: 7.4 Set Default umask for Users
umask 077
EOF
done
etckeeper commit "CIS: 7.4 Set Default umask for Users"

# CIS: 7.5 Lock Inactive User Accounts
useradd -D -f 35
etckeeper commit "CIS: 7.5 Lock Inactive User Accounts"

# CIS: 8.1 Set Warning Banner for Standard Login Services
# CIS: 8.2 Remove OS Information from Login Warning Banners
cat << EOF > /etc/issue
Authorized uses only.
All activity may be monitored and reported.

EOF
cat << EOF > /etc/issue.net
Authorized uses only.
All activity may be monitored and reported.

EOF
chown root:root /etc/motd
chown root:root /etc/issue
chown root:root /etc/issue.net
chmod 0644 /etc/motd
chmod 0644 /etc/issue
chmod 0644 /etc/issue.net
etckeeper commit "CIS: 8.1 Set Warning Banner for Standard Login Services (includes CIS 8.2)"

# CIS: 9.1.2 Verify Permissions on /etc/passwd
chmod 0644 /etc/passwd
etckeeper commit "CIS: 9.1.2 Verify Permissions on /etc/passwd"

# CIS: 9.1.3 Verify Permissions on /etc/shadow
chmod 0000 /etc/shadow
etckeeper commit "CIS: 9.1.3 Verify Permissions on /etc/shadow"

# CIS: 9.1.4 Verify Permissions on /etc/gshadow
chmod 0000 /etc/gshadow
etckeeper commit "CIS: 9.1.4 Verify Permissions on /etc/gshadow"

# CIS: 9.1.5 Verify Permissions on /etc/group
chmod 0644 /etc/group
etckeeper commit "CIS: 9.1.5 Verify Permissions on /etc/group"

# CIS: 9.1.6 Verify User/Group Ownership on /etc/passwd
chown root:root /etc/passwd
etckeeper commit "CIS: 9.1.6 Verify User/Group Ownership on /etc/passwd"

# CIS: 9.1.7 Verify User/Group Ownership on /etc/shadow
chown root:root /etc/shadow
etckeeper commit "CIS: 9.1.7 Verify User/Group Ownership on /etc/shadow"

# CIS: 9.1.8 Verify User/Group Ownership on /etc/gshadow
chown root:root /etc/gshadow
etckeeper commit "CIS: 9.1.8 Verify User/Group Ownership on /etc/gshadow"

# CIS: 9.1.9 Verify User/Group Ownership on /etc/group
chown root:root /etc/group
etckeeper commit "CIS: 9.1.9 Verify User/Group Ownership on /etc/group"

# CIS: 1.1.14 Add nodev Option to /dev/shm Partition
# CIS: 1.1.15 Add nosuid Option to /dev/shm Partition
# CIS: 1.1.16 Add noexec Option to /dev/shm Partition
sed -i 's/^tmpfs.*\/dev\/shm.*defaults.*//' /etc/fstab
cat << EOF >> /etc/fstab

# CIS: 1.1.14 Add nodev Option to /dev/shm Partition
# CIS: 1.1.15 Add nosuid Option to /dev/shm Partition
# CIS: 1.1.16 Add noexec Option to /dev/shm Partition
tmpfs                  /dev/shm                tmpfs   nodev,nosuid,noexec 0 0
EOF
etckeeper commit "CIS: 1.1.14-16 Add nodev,nosuid,noexec Option to /dev/shm Partition"

#
# CIS Benchmark items that can't be implemented at this time or are not applicable
#

# CIS: 1.2.4 Verify Package Integrity Using RPM (OK: this is a fresh PXE build)
# CIS: 1.7 Use the Latest OS Release (UNKNOWN: this is a fresh PXE build)
# CIS: 4.3.1 Deactivate Wireless Interfaces (UNKOWN: don't know if this system has wireless)
# CIS: 5.1.5 Configure rsyslog to Send Logs to a Remote Log Host (NOT COMPLIANT: leaving for administrator action
# CIS: 5.1.6 Accept Remote rsyslog Messages Only on Designated Log Hosts (OK: default is compliant)
# CIS: 5.2.1.1 Configure Audit Log Storage Size (OK: default is compliant)
# CIS: 6.2.1 Set SSH Protocol to 2 (N/A: ssh not installed)
# CIS: 6.2.2 Set LogLevel to INFO (N/A: ssh not installed
# CIS: 6.2.3 Set Permissions on /etc/ssh/sshd_config (N/A: ssh not installed)
# CIS: 6.2.4 Disable SSH X11 Forwarding (N/A: ssh not installed)
# CIS: 6.2.5 Set SSH MaxAuthTries to 4 or Less (N/A: ssh not installed)
# CIS: 6.2.6 Set SSH IgnoreRhosts to Yes (N/A: ssh not installed)
# CIS: 6.2.7 Set SSH HostbasedAuthentication to No (N/A: ssh not installed)
# CIS: 6.2.8 Disable SSH Root Login (N/A: ssh not installed)
# CIS: 6.2.9 Set SSH PermitEmptyPasswords to No (N/A: ssh not installed)
# CIS: 6.2.10 Do Not Allow Users to Set Environment Options (N/A: ssh not installed)
# CIS: 6.2.11 Use Only Approved Cipher in Counter Mode (N/A: ssh not installed)
# CIS: 6.2.12 Set Idle Timeout Interval for User Login (N/A: ssh not installed)
# CIS: 6.2.13 Limit Access via SSH (N/A: ssh not installed)
# CIS: 6.2.14 Set SSH Banner (N/A: ssh not installed)
# CIS: 6.4 Restrict root Login to System Console (OK: default is compliant)
# CIS: 7.2 Disable System Accounts (OK: default is compliant)
# CIS: 7.3 Set Default Group for root Account (OK: default is compliant)
# CIS: 8.3 Set GNOME Warning Banner (N/A: gnome not installed)
# CIS: 9.1.1 Verify System File Permissions (OK: default is compliant)
# CIS: 9.1.10 Find World Writable Files (OK: default is compliant)
# CIS: 9.1.11 Find Un-owned Files and Directories (OK: default is compliant)
# CIS: 9.1.12 Find Un-grouped Files and Directories (OK: default is compliant)
# CIS: 9.1.13 Find SUID System Executables (OK: default is compliant)
# CIS: 9.1.14 Find SGID System Executables (OK: default is compliant)
# CIS: 9.2.1 Ensure Password Fields are Not Empty (OK: default is compliant)
# CIS: 9.2.2 Verify No Legacy "+" Entries Exist in /etc/passwd File (OK: default is compliant)
# CIS: 9.2.3 Verify No Legacy "+" Entries Exist in /etc/shadow File (OK: default is compliant)
# CIS: 9.2.4 Verify No Legacy "+" Entries Exist in /etc/group File (OK: default is compliant)
# CIS: 9.2.5 Verify No UID 0 Accounts Exist Other Than root (OK: default is compliant)
# CIS: 9.2.6 Ensure root PATH Integrity (OK: default is compliant)
# CIS: 9.2.7 Check Permissions on User Home Directories (N/A: no users)
# CIS: 9.2.8 Check User Dot File Permissions (N/A: no users)
# CIS: 9.2.9 Check Permissions on User .netrc Files (N/A: no users)
# CIS: 9.2.10 Check for Presence of User .rhosts Files (N/A: no users)
# CIS: 9.2.11 Check Groups in /etc/passwd (OK: default is compliant)
# CIS: 9.2.12 Check That Users Are Assigned Valid Home Directories (OK: default is compliant)
# CIS: 9.2.13 Check User Home Directory Ownership (N/A: no users)
# CIS: 9.2.14 Check for Duplicate UIDs (OK: default is compliant)
# CIS: 9.2.15 Check for Duplicate GIDs (OK: default is compliant)
# CIS: 9.2.16 Check That Reserved UIDs Are Assigned to System Accounts (OK: default is compliant)
# CIS: 9.2.17 Check for Duplicate User Names (OK: default is compliant)
# CIS: 9.2.18 Check for Duplicate Group Names (OK: default is compliant)
# CIS: 9.2.19 Check for Presence of User .netrc Files (N/A: no users)
# CIS: 9.2.20 Check for Presence of User .forward Files (N/A: no users)

# All done!
echo "Kickstart load complete!!!" | ${LOGGER}
%end
